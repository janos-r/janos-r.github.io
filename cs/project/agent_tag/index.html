<!doctype html><html lang=cs><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Source Themes Academic 4.8.0"><meta name=author content="Radim Janoš"><meta name=description content="A tag game simulator with simple agents."><link rel=alternate hreflang=en href=/project/agent_tag/><link rel=alternate hreflang=ja href=/ja/project/agent_tag/><link rel=alternate hreflang=cs href=/cs/project/agent_tag/><meta name=theme-color content="#2962ff"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css integrity="sha256-FMvZuGapsJLjouA6k7Eo2lusoAX9i0ShlWFG6qt7SLc=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/github.min.css crossorigin=anonymous title=hl-light><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/dracula.min.css crossorigin=anonymous title=hl-dark disabled><script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin=anonymous async></script><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap"><link rel=stylesheet href=/css/academic.css><link rel=manifest href=/cs/index.webmanifest><link rel=icon type=image/png href=/images/icon_hub89e7b28a6abff2b4ec084e6c0608a00_13774_32x32_fill_lanczos_center_2.png><link rel=apple-touch-icon type=image/png href=/images/icon_hub89e7b28a6abff2b4ec084e6c0608a00_13774_192x192_fill_lanczos_center_2.png><link rel=canonical href=/cs/project/agent_tag/><meta property="twitter:card" content="summary_large_image"><meta property="og:site_name" content="Radim"><meta property="og:url" content="/cs/project/agent_tag/"><meta property="og:title" content="Agent based simulation modeling | Radim"><meta property="og:description" content="A tag game simulator with simple agents."><meta property="og:image" content="/cs/project/agent_tag/featured.png"><meta property="twitter:image" content="/cs/project/agent_tag/featured.png"><meta property="og:locale" content="cs"><meta property="article:published_time" content="2021-03-06T00:00:00+00:00"><meta property="article:modified_time" content="2021-03-06T00:00:00+00:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"/cs/project/agent_tag/"},"headline":"Agent based simulation modeling","image":["/cs/project/agent_tag/featured.png"],"datePublished":"2021-03-06T00:00:00Z","dateModified":"2021-03-06T00:00:00Z","author":{"@type":"Person","name":"Radim Janoš"},"publisher":{"@type":"Organization","name":"Radim","logo":{"@type":"ImageObject","url":"/images/icon_hub89e7b28a6abff2b4ec084e6c0608a00_13774_192x192_fill_lanczos_center_2.png"}},"description":"A tag game simulator with simple agents."}</script><title>Agent based simulation modeling | Radim</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents><aside class=search-results id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Hledání</h1></div><div class="col-6 col-search-close"><a class=js-search href=#><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Hledání... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search class=form-control></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/cs>Radim</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar aria-expanded=false aria-label="Přepnout navigaci">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/cs>Radim</a></div><div class="navbar-collapse main-menu-item collapse justify-content-end" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/cs/#about><span>Profil</span></a></li><li class=nav-item><a class=nav-link href=/cs/#skills_lang><span>Znalosti</span></a></li><li class=nav-item><a class=nav-link href=/cs/#experience><span>Zkušenosti</span></a></li><li class=nav-item><a class=nav-link href=/cs/#projects><span>Projekty</span></a></li><li class=nav-item><a class=nav-link href=/cs/#contact><span>Kontakt</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=Hledání><i class="fas fa-search" aria-hidden=true></i></a></li><li class="nav-item dropdown theme-dropdown"><a href=# class="nav-link js-theme-selector" data-toggle=dropdown aria-haspopup=true><i class="fas fa-palette" aria-hidden=true></i></a><div class=dropdown-menu><a href=# class="dropdown-item js-set-theme-light"><span>Light</span></a>
<a href=# class="dropdown-item js-set-theme-dark"><span>Dark</span></a>
<a href=# class="dropdown-item js-set-theme-auto"><span>Automatic</span></a></div></li><li class="nav-item dropdown i18n-dropdown"><a href=# class=nav-link data-toggle=dropdown aria-haspopup=true><i class="fas fa-globe mr-1" aria-hidden=true></i></a><div class=dropdown-menu><div class="dropdown-item dropdown-item-active"><span>Česky</span></div><a class=dropdown-item href=/project/agent_tag/><span>English</span></a>
<a class=dropdown-item href=/ja/project/agent_tag/><span>日本語</span></a></div></li></ul></div></nav><article class="article article-project"><div class="article-container pt-3"><h1>Agent based simulation modeling</h1><p class=page-subtitle>A tag game simulator with simple agents.</p><div class=article-metadata><span class=article-date>6 March 2021</span></div><div class="btn-links mb-3"><a class="btn btn-outline-primary my-1 mr-1" href=https://github.com/janos-r/agent-tag target=_blank rel=noopener><i class="fab fa-github mr-1"></i>Project on GitHub</a></div></div><div class="article-header article-container featured-image-wrapper mt-4 mb-4" style=max-width:504px;max-height:572px><div style=position:relative><img src=/cs/project/agent_tag/featured.png alt class=featured-image></div></div><div class=article-container><div class=article-style><h2 id=motivation-and-lessons-learned>Motivation and lessons learned</h2><p>My first attempt of an agent based simulation model. The agents themselves are purely random in their behavior, which can make this project look incomplete. But the purpose of this exercise was to see if I can even manage to set it up and get it working.</p><p>I did this over the weekend and got allot of new experience thanks to it. I got to try out
<a href=https://crates.io/crates/structopt target=_blank rel=noopener>structopt</a> a cli input tool which I absolutely love and can&rsquo;t recommend enough. I also tried out
<a href=https://crates.io/crates/rayon target=_blank rel=noopener>Rayon</a> for the first time. It was a good experience to fixing structs so that they become &ldquo;send&rdquo;. But in the end, rayon didn&rsquo;t improve the performance of my particular code. It would require further deeper analysis to find out why exactly, but my very simple &ldquo;benchmark&rdquo; is bellow. Again, it was rather about the experience than about making the fastest possible multithreaded implementation possible.</p><p>The probably biggest experience I got out of this exercise was the use of Rc, RefCell and weak links.</p><p>When one agent needs to mutate another (tag) another. How can one object in a Vec change the one next to it. It has been a while since I was using RCs. But you can&rsquo;t give a normal mutable ref to them, so I just tried it with RCs and thought it should be ok. I encountered a huge block and was totally lost when that didn&rsquo;t work and I didn&rsquo;t understand why.
After a while, I found an example using weak links. I never used those before, but I gave it a try. I realized why I&rsquo;m getting the error about the RC being already borrowed. Through the first RC I get to the Agent itself, and then I&rsquo;m trying again to use the same RC from inside the Agent - that was the issue. This got solved by cloning the agent with its owned link. Thereby dropping the initially established connection. Now I can use the link from inside the cloned Agent. This works, but somehow it it doesn&rsquo;t feel right. I still remember writing this code and I felt dirty. But the next challenge was right around the corner. When you try to print out sch an agent, it will try to resolve its link to the parent, finding again the same child, resolving it&rsquo;s link to the parent and so on. With that I got possibly my first stack overflow in Rust. You can imagine my frustration at this point, I was still lost. But fortunately getting back to those weak links and the
<a href="https://doc.rust-lang.org/book/ch15-06-reference-cycles.html?highlight=weak#adding-a-reference-from-a-child-to-its-parent" target=_blank rel=noopener>example in the Book</a> solved this issue. A weak link doesn&rsquo;t resolve immediately, causing this loop, but needs to be called explicitly. And it should be possible to call it, since it&rsquo;s called from a clone, who&rsquo;s link is not used anymore at that moment. This way, any time the link is used, a clone is being made. I still don&rsquo;t know about a better solution. After this started working, I felt like getting away with murder and somehow still not happy, but at least with hope that I could finish this exercise.</p><p>Later when I changed the Rc for Arc, this loop issue solved with weak links became not necessary anymore. Since you have to lock Mutex also explicitly. But well, was still a good experience.</p><h2 id=simulation-rules>Simulation rules</h2><h3 id=movement>Movement</h3><p>All agents move on every tic one space in one of their neighboring directions (up, down, left right) on random. If they cross a wall, they pop out on the other side.</p><h3 id=tagging>Tagging</h3><p>At the start, one agent is chosen as &ldquo;it&rdquo; on random. If and another agent come next to each other (on one of the four directions) the tag is exchanged. The previously tagged agent becomes impossible to tag again, until another tag is exchanged.</p><h2 id=build>Build</h2><pre><code class=language-shell>cargo build --release
</code></pre><h2 id=run>Run</h2><p>The most interesting use of this piece of code at this moment, is to see how the amount of exchanged tags can change when changing the options of the world. With the flags bellow, it is very easy to adjust the size of the world, the number of agents and how many moves they make.</p><ul><li><p>Either the build result from the previous step.</p><pre><code class=language-shell>cd target/release/
./agent-tag
</code></pre></li><li><p>Or through cargo</p><pre><code class=language-shell>cargo run
</code></pre><ul><li><p>add flags to the cargo format after <code>--</code></p><pre><code class=language-shell>cargo run -- -h
</code></pre></li></ul></li></ul><h2 id=options>Options</h2><p>Please see the flags and options bellow. All of them have sensible defaults, so just running the program without any should give you still a reasonable result.</p><h3 id=help-text>Help text</h3><pre><code class=language-shell>agent-tag --help
</code></pre><pre><code class=language-output>agent-tag 0.1.0
A tag game simulator with stupid agents

USAGE:
    agent-tag [FLAGS] [OPTIONS]

FLAGS:
    -d, --disable-grid      Adding this flag disables the output of the field (grid). For benchmarking, when printing
                            the grid on the cli is not required
    -h, --help              Prints help information
    -p, --print-announce    During a run, announce that in the next visible frame, a tag will occur. Otherwise it is
                            easy to miss it
    -V, --version           Prints version information

OPTIONS:
    -a, --agents &lt;agents&gt;    Number of agents [default: 40]
    -m, --moves &lt;moves&gt;      Number of moves (tics) before the program finishes. Important for benchmarking, otherwise a
                             simple kill ^C works too [default: 10]
    -s, --size &lt;size&gt;        Size of field (grid) [default: 25]
    -t, --time &lt;time&gt;        Number of ms between tics [default: 1000]

</code></pre><h3 id=very-simple-benchmark>Very simple benchmark</h3><p>Just running <code>time</code> (the common linux tool). This example runs with 10.000 moves. When -t0 is set, there is no thread sleep called between the moves. Toggling the -d flag shows how much time is spent on the graphical aspect of the program.</p><pre><code class=language-shell>time target/release/agent-tag -t0 -m10000 -d

</code></pre><p>Without Rayon:</p><pre><code class=language-output>________________________________________________________
Executed in   19,63 millis    fish           external 
   usr time   19,61 millis  528,00 micros   19,08 millis 
   sys time    0,21 millis  215,00 micros    0,00 millis 
</code></pre><p>with Rayon:</p><pre><code class=language-output>________________________________________________________
Executed in  155,57 millis    fish           external 
   usr time  1208,72 millis  748,00 micros  1207,97 millis 
   sys time  541,37 millis    0,00 micros  541,37 millis 

</code></pre><p>The results are surprising. The refactor from Rc to Arc (and giving each agent it&rsquo;s own RNG) didn&rsquo;t slow down the run much. But when then used with Rayon, to use more threads for the many agents, the release binary actually ran 4x slower. Even when raising the number of agents from 40 to 400, the binary without Rayon (single threaded) was 4x faster.
Sometimes the results can vary allot based on use case and that&rsquo;s why these tests can be so useful when implementing parallelism. I left the two tested functions commented in the code with &ldquo;# Raion&rdquo;</p><p>Running just <code>time</code> is not a perfect benchmarking tool, especially for results under a second. But good enough for rough comparisons between different setups I guess.</p></div><div class=article-tags><a class="badge badge-light" href=/cs/tag/code/>Code</a>
<a class="badge badge-light" href=/cs/tag/rust/>Rust</a></div><div class="media author-card content-widget-hr"><img class="avatar mr-3 avatar-circle" src=/cs/author/radim-janos/avatar_hu64d921ec107bff3d62a3fb75542fa15a_49188_270x270_fill_q90_lanczos_center.jpg alt="Radim Janoš"><div class=media-body><h5 class=card-title><a href=/>Radim Janoš</a></h5><h6 class=card-subtitle>Programátor</h6><ul class=network-icon aria-hidden=true><li><a href=/cs/#contact><i class="fas fa-envelope"></i></a></li><li><a href=https://github.com/janos-r target=_blank rel=noopener><i class="fab fa-github"></i></a></li><li><a href=/files/CV_Radim_Janos-%28en%29.pdf><i class="ai ai-cv"></i></a></li></ul></div></div><div class="article-widget content-widget-hr"><h3>Související</h3><ul><li><a href=/cs/project/agent_tag_bevy/>Game engine</a></li><li><a href=/cs/project/yewban/>Yewban</a></li><li><a href=/cs/project/exercism/>Exercism.io</a></li><li><a href=/cs/project/graphql_rust/>API in Rust</a></li><li><a href=/cs/project/gemini/>Gemini</a></li></ul></div><div class="project-related-pages content-widget-hr"></div></div></article><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.1.0/instantpage.min.js integrity="sha512-1+qUtKoh9XZW7j+6LhRMAyOrgSQKenQ4mluTR+cvxXjP1Z54RxZuzstR/H9kgPXQsVB8IW7DMDFUJpzLjvhGSQ==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/highlight.min.js integrity="sha512-7t8APmYpzEsZP7CYoA7RfMPV9Bb+PJHa9x2WiUnDXZx3XHveuyWUtvNOexhkierl5flZ3tr92dP1mMS+SGlD+A==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/r.min.js></script><script>const code_highlighting=true;</script><script>const isSiteThemeDark=false;</script><script>const search_config={"indexURI":"/cs/index.json","minLength":1,"threshold":0.3};const i18n={"no_results":"Nic nelalezeno","placeholder":"Hledání...","results":"nalezených výsledků"};const content_type={'post':"Aktuality",'project':"Projekty",'publication':"Publikace",'talk':"Přednášky",'slides':"Slides"};</script><script id=search-hit-fuse-template type=text/x-template>
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script><script src=https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin=anonymous></script><script src=/js/academic.min.3b2b658c61ebd725bd5fc606c89fe44c.js></script><div class=container><footer class=site-footer><p class=powered-by><span class=float-right aria-hidden=true><a href=# class=back-to-top><span class=button_icon><i class="fas fa-chevron-up fa-2x"></i></span></a></span></p></footer></div><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Citace</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code class="tex hljs"></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i>Kopírovat</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i>Stáhnout</a><div id=modal-error></div></div></div></div></div></body></html>